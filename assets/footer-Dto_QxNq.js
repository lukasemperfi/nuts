(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function r(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=r(o);fetch(o.href,a)}})();const h="";console.log("Supabase клиент инициализирован.");class N{getAllProducts=async(t={})=>{console.log("from API:",t);const{flavor:r=[],weight:s=[],sort:o=null}=t;let a=h.from("products").select(`
        *,
        product_images (*),
        product_flavors!inner (
          flavor_id,
          flavors!inner (*)
        ),
        packaging_types (*),
        product_statuses (*)
      `).limit(6);r.length>0&&(a=a.in("product_flavors.flavors.value",r)),s.length>0&&(a=a.in("weight",s)),(o==="asc"||o==="desc")&&(a=a.order("price",{ascending:o==="asc"}));const{data:n,error:c}=await a;return c?(console.error("Ошибка при получении продуктов:",c.message),[]):n};getProductById=async t=>{if(!t||isNaN(t))return null;const{data:r,error:s}=await h.from("products").select(`
        *,
        product_images (
          id,
          image_path_png,
          image_path_webp,
          is_main,
          sort_order
        ),
        product_flavors (
          flavor_id,
          flavors (
            id,
            name,
            value
          )
        ),
        packaging_types (
          id,
          name
        ),
        product_statuses (
          id,
          name
        )
      `).eq("id",t).single();return s?(s.code==="PGRST116"||console.error("Ошибка при получении продукта:",s),null):r}}const P=new N,v={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},O={items:[],status:v.IDLE,error:null,lastFetched:null},T={name:"products",initialState:O,reducers:{setLoading:e=>({...e,status:v.LOADING,error:null}),setProducts:(e,t)=>({...e,items:t.payload,status:v.SUCCEEDED,error:null,lastFetched:new Date().toISOString()}),setError:(e,t)=>({...e,status:v.FAILED,error:t.payload}),clearError:e=>({...e,error:null}),reset:()=>O}};async function H(e){if(l.getState().products.status!==v.LOADING){l.dispatch({type:"products/setLoading"});try{const r={...e,weight:e?.weight?.map(o=>Number(o))||[]};console.log("Fetching products",r);const s=await P.getAllProducts(r);return l.dispatch({type:"products/setProducts",payload:s}),s}catch(r){const s=r.message||"Unknown error occurred";throw l.dispatch({type:"products/setError",payload:s}),r}}}const x={name:"productFilters",initialState:{filters:{weight:[],flavor:[],sort:null},isInitialized:!1},reducers:{setFilters:(e,t)=>({...e,filters:{...e.filters,...t.payload}}),setInitialized:(e,t)=>({...e,isInitialized:t.payload}),resetFilters:e=>({...e,filters:{weight:[],flavor:[],sort:null}})}},W={setFilters:e=>({type:"productFilters/setFilters",payload:e}),setInitialized:e=>({type:"productFilters/setInitialized",payload:e}),resetFilters:()=>({type:"productFilters/resetFilters"})},w={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},C={item:null,status:w.IDLE,error:null,lastFetched:null,currentId:null},G={name:"product",initialState:C,reducers:{setLoading:e=>({...e,status:w.LOADING,error:null}),setProduct:(e,t)=>({...e,item:t.payload,status:w.SUCCEEDED,error:null,lastFetched:new Date().toISOString(),currentId:t.payload?.id||null}),setError:(e,t)=>({...e,status:w.FAILED,error:t.payload,item:null}),clearError:e=>({...e,error:null}),reset:()=>C}};async function J(e){const t=l.getState().product;if(!(t.status===w.LOADING&&t.currentId===e)){if(t.status===w.SUCCEEDED&&t.currentId===e&&t.item)return t.item;l.dispatch({type:"product/setLoading"});try{const r=await P.getProductById(e);return r?(l.dispatch({type:"product/setProduct",payload:r}),r):(l.dispatch({type:"product/setError",payload:"Продукт не найден"}),null)}catch(r){const s=r.message||"Не удалось загрузить продукт";throw l.dispatch({type:"product/setError",payload:s}),r}}}class z{onAuthChange(t){const{data:r}=h.auth.onAuthStateChange((s,o)=>{t(s,o)});return()=>{r.subscription.unsubscribe()}}async login({email:t,password:r}){const{data:s,error:o}=await h.auth.signInWithPassword({email:t,password:r});if(o)throw o;return s}async logout(){const{error:t}=await h.auth.signOut();if(t)throw t;return!0}async registerUser(t){const{email:r,password:s,full_name:o,phone:a,person_type:n,upload_file:c,country:_,region:g,city:d,address:A}=t,{data:y,error:m}=await h.auth.signUp({email:r,password:s});if(m)throw console.error("Ошибка регистрации в Auth:",m.message),m;const S=y.user.id;let L=null;if(c&&c.name){const f=c.name.split(".").pop(),p=`${S}.${f}`,{error:I}=await h.storage.from("avatars").upload(p,c,{cacheControl:"no-cache",upsert:!0});I&&console.warn("Предупреждение: Ошибка загрузки аватара, продолжение регистрации:",I.message);const{data:q}=h.storage.from("avatars").getPublicUrl(p);L=q.publicUrl}const i={id:S,full_name:o,phone:a,country:_||null,region:g||null,city:d||null,address:A||null,person_type:n,avatar_url:L},{error:u}=await h.from("profiles").insert([i]);if(u)throw console.error("Ошибка вставки в profiles:",u.message),u;if(n==="fop"&&t.fop){const f={profile_id:S,edrpou:t.fop.edrpou,country:t.fop.country||null,region:t.fop.region||null,city:t.fop.city||null,address:t.fop.address||null},{error:p}=await h.from("fop_details").insert([f]);if(p)throw console.error("Ошибка вставки в fop_details:",p.message),p}else if(n==="legal"&&t.legal_entity){const f={profile_id:S,okpo:t.legal_entity.okpo,country:t.legal_entity.country||null,region:t.legal_entity.region||null,city:t.legal_entity.city||null,address:t.legal_entity.address||null,postal_code:t.legal_entity.postal_code||null},{error:p}=await h.from("legal_entity_details").insert([f]);if(p)throw console.error("Ошибка вставки в legal_entity_details:",p.message),p}return y}}const b=new z,E={IDLE:"idle",LOADING:"loading",SUCCEEDED:"succeeded",FAILED:"failed"},F={user:null,session:null,isAuth:!1,status:E.IDLE,error:null},$={name:"auth",initialState:F,reducers:{setLoading:e=>({...e,status:E.LOADING,error:null}),setAuth:(e,t)=>({...e,status:E.SUCCEEDED,error:null,user:t.payload.user,session:t.payload.session,isAuth:!!t.payload.session}),setError:(e,t)=>({...e,status:E.FAILED,error:t.payload,user:null,session:null,isAuth:!1}),clearError:e=>({...e,error:null}),resetAuth:()=>F}};async function j(e){if(l.getState().auth.status!==E.LOADING){l.dispatch({type:"auth/setLoading"});try{const r=await b.registerUser(e);return l.dispatch({type:"auth/setAuth",payload:{user:r.user,session:r.session}}),r}catch(r){const s=r.message||"Не удалось завершить регистрацию";throw l.dispatch({type:"auth/setError",payload:s}),r}}}async function X(e,t){l.dispatch({type:"auth/setLoading"});try{return await b.login({email:e,password:t})}catch(r){throw l.dispatch({type:"auth/setError",payload:r.message}),r}}async function R(){try{await b.logout()}catch(e){console.error("Logout error:",e)}}function M(){b.onAuthChange((e,t)=>{const r=l.getState().auth;if(e==="INITIAL_SESSION"||e==="SIGNED_IN"||e==="TOKEN_REFRESHED"){t&&!r.session&&l.dispatch({type:"auth/setAuth",payload:{user:t.user,session:t}});return}if(e==="SIGNED_OUT"){console.log("log out"),l.dispatch({type:"auth/resetAuth"});return}if(e==="PASSWORD_RECOVERY"){l.dispatch({type:"auth/setPasswordRecovery"});return}})}class B{constructor(){this.state={},this.reducers={},this.listeners=new Map,this.persistConfig={},this.storageKey="app_store"}registerSlice(t,r={persist:!1,fields:null}){const o=this.loadFullStoreFromStorage()[t.name];this.state[t.name]=o||t.initialState,this.reducers[t.name]=t.reducers,this.persistConfig[t.name]=r}getState(){return this.state}dispatch(t){const[r,s]=t.type.split("/");if(!r||!s){console.error(`Некорректный action.type: ${t.type}. Ожидается 'slice/reducer'.`);return}const o=this.reducers[r];if(!o||!o[s]){console.warn(`Не найден редьюсер ${s} в слайсе ${r}.`);return}const a=o[s],n=this.state[r],c=a(n,t);this.state[r]=c,this.saveSliceToFullStorage(r,c),this.notify(r,c)}subscribe(t,r){this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(r);const s=this.state[t];s!==void 0&&r(s)}unsubscribe(t,r){this.listeners.has(t)&&(this.listeners.get(t).delete(r),this.listeners.get(t).size===0&&this.listeners.delete(t),console.log(`Отписана функция от события: ${t}`))}notify(t,r){if(!this.listeners.has(t)){console.log(`Нет подписчиков на событие: ${t}`);return}this.listeners.get(t).forEach(s=>{s(r)})}loadFullStoreFromStorage(){const t=localStorage.getItem(this.storageKey);if(!t)return{};try{return JSON.parse(t)}catch{return{}}}saveSliceToFullStorage(t,r){const s=this.persistConfig[t];if(!s?.persist)return;const o=this.loadFullStoreFromStorage();let a=r;Array.isArray(s.fields)&&(a={},s.fields.forEach(n=>{r.hasOwnProperty(n)&&(a[n]=r[n])})),o[t]=a,localStorage.setItem(this.storageKey,JSON.stringify(o))}}const l=new B;l.registerSlice($);l.registerSlice(T);l.registerSlice(x);l.registerSlice(G);M();l.subscribe("auth",async e=>{console.log("Auth State Changed:",e)});const Y=({selector:e,onChange:t,defaultValues:r=[]})=>{const s=document.querySelector(e),o=s.dataset.multiple==="true",a=s.querySelector(".dropdown__button"),n=s.querySelector(".dropdown__selected"),c=s.querySelectorAll(".dropdown__option"),_=s.querySelector(".dropdown__dropdown"),g=s.querySelector("select");let d=[];const A=()=>{const i=a.getAttribute("aria-expanded")==="true";a.setAttribute("aria-expanded",String(!i))},y=()=>{a.setAttribute("aria-expanded","false")},m=()=>{const i=d.map(u=>u.querySelector(".dropdown__label").textContent.trim());n.textContent=i.length>0?i.join(", "):n.dataset.placeholder||"Select...",g&&(o?g.value=d.map(u=>u.dataset.value):g.value=d[0]?.dataset.value||"",g.dispatchEvent(new Event("change")))},S=i=>{const u=i.getAttribute("aria-selected")==="true";o?u?(i.setAttribute("aria-selected","false"),d=d.filter(f=>f!==i)):(i.setAttribute("aria-selected","true"),d.push(i)):(c.forEach(f=>f.removeAttribute("aria-selected")),i.setAttribute("aria-selected","true"),d=[i],y()),m()};return a.addEventListener("click",A),_.addEventListener("click",i=>{const u=i.target.closest(".dropdown__option");if(u&&(i.stopPropagation(),S(u),t)){const f=u.dataset.value,p=s.dataset.name;t(p,f)}}),document.addEventListener("click",i=>{s.contains(i.target)||y()}),n.dataset.placeholder=n.textContent.trim(),r.length>0&&(c.forEach(i=>{const u=i.dataset.value;r.includes(u)&&(i.setAttribute("aria-selected","true"),d.push(i))}),m()),{reset:()=>{c.forEach(i=>i.removeAttribute("aria-selected")),d=[],m()}}};function U(e=".nav-menu__link",t="active"){const r=o=>o?"/"+o.replace(/^\/+|\/+$/g,""):"/",s=r(window.location.pathname);document.querySelectorAll(e).forEach(o=>{const a=o.getAttribute("href");if(!a||a.startsWith("#"))return;r(a)===s?(o.classList.add(t),o.style.pointerEvents="none",o.style.cursor="default",o.setAttribute("aria-disabled","true")):(o.classList.remove(t),o.style.pointerEvents="",o.style.cursor="",o.removeAttribute("aria-disabled"))})}function Q(){k(),K(),U(".nav-menu__link"),document.querySelectorAll(".auth a").forEach(s=>{const o=s.getAttribute("href").replace(/\/+$/,""),a=window.location.pathname.replace(/\/+$/,"");o===a&&(s.classList.add("active"),s.addEventListener("click",n=>n.preventDefault()))});const t=document.querySelector(".top-header__auth"),r=document.createElement("button");r.textContent="Выйти X",r.style.color="red",r.addEventListener("click",async()=>{await R()}),l.subscribe("auth",s=>{s.status===E.IDLE&&t.contains(r)&&t.removeChild(r),s.status,E.LOADING,s.status===E.SUCCEEDED&&(t.contains(r)||t.appendChild(r))})}function k(){const e=document.querySelector(".middle-header__burger-btn"),t=document.querySelector(".mobile-menu"),r=document.querySelector(".mobile-menu__close");!e||!t||(e.addEventListener("click",function(){const s=t.classList.toggle("is-open");e.setAttribute("aria-expanded",s?"true":"false"),document.body.style.overflow=s?"hidden":"auto"}),r&&r.addEventListener("click",()=>{t.classList.remove("is-open"),e.setAttribute("aria-expanded","false"),document.body.style.overflow="auto"}))}function K(){const e=document.querySelector(".mobile-menu"),t=document.querySelector(".middle-header__burger-btn");!e||!t||window.addEventListener("resize",function(){e.classList.contains("is-open")&&(e.classList.remove("is-open"),t.setAttribute("aria-expanded","false"),document.body.style.overflow="auto")})}function V(e=".lazy",t={}){const s={...{root:null,rootMargin:"0px",threshold:.01},...t},o=document.querySelectorAll(e);if("IntersectionObserver"in window){let a=o.length;const n=(_,g)=>{_.forEach(d=>{if(d.isIntersecting){const A=d.target;D(A,e);const y=A.closest("picture");y&&y.querySelectorAll("source[data-srcset]").forEach(S=>D(S,e)),g.unobserve(A),a--,a===0&&g.disconnect()}})},c=new IntersectionObserver(n,s);o.forEach(_=>{c.observe(_)})}else o.forEach(a=>D(a,e))}function D(e,t){const r=e.tagName.toLowerCase()==="iframe",s="/nuts/";e.dataset.src&&(e.src=r?e.dataset.src:s+e.dataset.src.replace(/^\/+/,""),delete e.dataset.src),e.dataset.srcset&&(e.srcset=r?e.dataset.srcset:s+e.dataset.srcset.replace(/^\/+/,""),delete e.dataset.srcset),e.classList.contains(t.replace(".",""))&&e.classList.remove(t.replace(".",""))}const Z=()=>{U(".nav-menu__link")};export{E as A,v as P,Q as a,Z as b,X as c,H as d,J as f,Y as i,V as l,W as p,j as r,l as s};
