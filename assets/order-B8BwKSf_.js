import{k as n}from"./footer-B8T5AYVf.js";class l{async createOrder(r){if(!r||!r.products||r.products.length===0)throw new Error("Объект заказа или список продуктов недействителен.");const{data:{user:i}}=await n.auth.getUser();if(!i)throw new Error("Необходимо авторизоваться для оформления заказа.");const e=i.id,o=r[r.delivery_method];let d=null;try{const t={user_id:e,order_number:this.generateOrderNumber(),full_name:r.full_name,email:r.email,phone:r.phone,delivery_method:r.delivery_method,payment_method:r.payment_method,status:"новый",total_amount:r.total_amount},{data:s,error:a}=await n.from("orders").insert([t]).select("id").single();if(a)throw a;d=s.id}catch(t){throw console.error("Ошибка (A) при вставке в orders:",t),new Error("Не удалось создать основную запись заказа.")}try{const t=r.products.map(a=>({order_id:d,product_id:a.productId,quantity:a.quantity})),{error:s}=await n.from("order_items").insert(t);if(s)throw await this.rollbackOrder(d,"order_items"),s}catch(t){throw console.error("Ошибка (B) при вставке в order_items:",t),new Error("Не удалось добавить продукты в заказ.")}if(o)try{const t={order_id:d,country:o.country||null,region:o.region||null,city:o.city||null,address:o.address||null},{error:s}=await n.from("order_delivery_details").insert([t]);if(s)throw await this.rollbackOrder(d,"order_delivery_details"),s}catch(t){throw console.error("Ошибка (C) при вставке в order_delivery_details:",t),new Error("Не удалось добавить детали доставки.")}return d}async getOrders(){const{data:{user:r}}=await n.auth.getUser();if(!r)throw new Error("Необходимо авторизоваться для просмотра заказов.");const i=r.id;try{const{data:e,error:o}=await n.from("orders").select(`
                    *,
                    order_items (
                        product_id,
                        quantity
                    ),
                    order_delivery_details (
                        country,
                        region,
                        city,
                        address
                    )
                `).eq("user_id",i).order("created_at",{ascending:!1});if(o)throw console.error("Ошибка Supabase при получении заказов:",o),new Error(o.message||"Не удалось получить список заказов.");return e}catch(e){throw console.error("Ошибка в ordersApi.getOrders:",e),e}}generateOrderNumber(){return Date.now().toString().slice(-8)+Math.random().toString(36).substring(2,6)}async rollbackOrder(r,i){console.warn(`Попытка отката заказа ${r} после ошибки на шаге: ${i}`);try{const{error:e}=await n.from("orders").delete().eq("id",r);if(e)throw e;console.warn(`Успешно откатили неполный заказ ${r}.`)}catch(e){console.error(`Критическая ошибка при откате заказа ${r}. Требуется ручная чистка!`,e)}}}const w=new l;export{w as o};
